define(["jquery"],(function($){var logListModuleObj;return function(){var maxFilters=5,filterNumber=1,globalCurrentPage,globalOrderField,currentOrderByField,currentOrderByType,countOrder,url="ajax/ajaxGetFilteredData.php",ajaxCall,listnameAction,defaultParam,i=0,jsonFilters=JSON.parse($("#filterJson").val()),rules={"=":"è uguale",like:"contiene","not like":"non contiene","<>":"è diverso","<":"è minore","<=":"è minore o uguale",">":"è maggiore",">=":"è maggiore o uguale"};function init(){listnameAction="logList",countOrder=0,globalCurrentPage=1,currentOrderByType="DESC",currentOrderByField="id",globalOrderField="id",ajaxCall=!1,defaultParam={field:"id",rule:">=",input:"0"},renderFilterField(),bindChangeForLimitQuery(),bindFilterButton(),bindClickForResetQuery(),bindClickForOrderBy(),bindClickForNextPage(),bindFilterEnterButton(),bindSubmitForm(),bindDynamicFilter(),deleteFilter()}function submitFilters(){var queryArray=[];$(".filterToClone").each((function(){var fieldOptionSelected=$(this).find(".form-control[id*='field']"),conditionOptionSelected=$(this).find(".form-control[id*='condition']"),valueAndInput=$(this).find(".form-control[id*='value']"),query={};if(null==fieldOptionSelected.val()||""==fieldOptionSelected.val().trim()?query.field=defaultParam.field:query.field=fieldOptionSelected.val().trim(),null==conditionOptionSelected.val()||""==conditionOptionSelected.val().trim()?query.rule=defaultParam.rule:query.rule=conditionOptionSelected.val().trim(),null==valueAndInput.val()||""==valueAndInput.val().trim())query.input=defaultParam.input;else if(query.input=valueAndInput.val().trim(),valueAndInput.hasClass("hasDatepicker")){var timestampFromDate=new Date(query.input);query.input=timestampFromDate.getTime()/1e3}queryArray.push(query)}));var dataToSend={},sortingTable=$(".sortingTable");return""==sortingTable.val()&&null==sortingTable.val()||(dataToSend.perPage=$(".sortingTable").val()),dataToSend.orderBy=currentOrderByField,dataToSend.orderType=currentOrderByType,dataToSend.currentPage=globalCurrentPage,dataToSend.filterPage=listnameAction,dataToSend.filters=queryArray,dataToSend}function addFilter(toClone){$(document).on("click",".addFilter",(function(){if(filterNumber<5){$("#container_filter").append(toClone.clone());var clonedElements=$(".filterToClone");$(clonedElements).length>1&&$(".deleteFilter").removeClass("d-none"),i++;var lastFilter=$(clonedElements).last();$(lastFilter).find("#field").attr("id","field"+i),$(lastFilter).find("#condition").attr("id","condition"+i),$(lastFilter).find("#value").attr("id","value"+i),filterNumber++}}))}function deleteFilter(){$(document).on("click",".deleteFilter",(function(){$(this).closest(".filterToClone").remove(),filterNumber--,1==$(".filterToClone").length&&$(".deleteFilter").addClass("d-none")}))}function bindSubmitForm(){$(document).on("click",".btn-edit",(function(){CSRFCheckManager.addToForm(".modifyAction")})),$(document).on("submit","#downloadMap",(function(){CSRFCheckManager.addToForm("#downloadMap")}))}function bindFilterEnterButton(){$(document).on("keypress","[id^='value']",(function(e){13==e.which&&(globalCurrentPage=1,$("#filterData").trigger("click"))}))}function bindDynamicFilter(){$(document).on("change",".selectField",(function(e){var fieldFormGroup=$(this).parent(),filter_name=$(this).val();$(fieldFormGroup).siblings(".input").find("input").val("");var select=$(fieldFormGroup).siblings(".rules").find(".select").empty();for(x in jsonFilters)if(x==filter_name&&jsonFilters[x][0].canFilter){var optionRules=jsonFilters[x][0].rule.split(",");for(y in optionRules)$(select).append("<option value='"+optionRules[y]+"'>"+rules[optionRules[y]]+"</option>");if("select"==jsonFilters[x][0].valueType){var inputId=$(fieldFormGroup).siblings(".input").find("input").attr("id");$(fieldFormGroup).siblings(".input").empty(),$(fieldFormGroup).siblings(".input").append("<select class='form-control select-xs noSelectize select selectCondition' id='"+inputId+"' name='value' ></select>");var options=jsonFilters[x][0].option.split("/"),optionsValue=jsonFilters[x][0].optionValue.split("/");for(z in options)$(fieldFormGroup).siblings(".input").find("select").append("<option value='"+optionsValue[z]+"'>"+options[z]+"</option>")}else if(0==$(fieldFormGroup).siblings(".input").find("input").length){var inputId=$(fieldFormGroup).siblings(".input").find("select").attr("id");$(fieldFormGroup).siblings(".input").empty(),$(fieldFormGroup).siblings(".input").append("<input type='text' name='value' placeholder='Valore' class='form-control input-xs' id='"+inputId+"' >")}null!=jsonFilters[x][0].max_length?$(fieldFormGroup).siblings(".input").find("input").attr("maxlength",jsonFilters[x][0].max_length):$(fieldFormGroup).siblings(".input").find("input").removeAttr("maxlength")}}))}function bindFilterButton(){$(document).on("click","#filterData",(function(e){ajaxGetFilteredData()}))}function ajaxGetFilteredData(){if($(".removeDuplicate").remove(),ajaxCall)return!1;var dataLimit;ajaxCall=!0,""==$(".sortingTable").val()&&null==$(".sortingTable").val()||(dataLimit=$(".sortingTable").val());var dataToSend=submitFilters();null!=CSRFCheckManager&&void 0!==CSRFCheckManager&&(dataToSend=CSRFCheckManager.concatToOjb(dataToSend)),$.ajax({type:"POST",url:url,data:dataToSend,dataType:"json",cache:!1,success:function(response){response.error?(renderPagination(response,dataLimit),$(".tableToPaste .noData").closest("td").removeClass("d-none")):(renderTable(response),renderPagination(response,dataLimit)),ajaxCall=!1},error:function(response){ajaxCall=!1},failure:function(response){ajaxCall=!1}})}function bindClickForResetQuery(){$(document).on("click","#filterReset",(function(e){globalCurrentPage=1,$(".input-xs").val(""),$(".deleteFilter").trigger("click"),$(".addFilter").trigger("click"),ajaxGetFilteredData()}))}function bindChangeForLimitQuery(){$(".sortingTable").on("change",(function(){globalCurrentPage=1,ajaxGetFilteredData()}))}function bindClickForOrderBy(){$(".table th").not($(".noBindClick")).on("click",(function(){calcParamForOrderby($(this)),ajaxGetFilteredData()}))}function bindClickForNextPage(){$(document).on("click",".customPagination li",(function(e){var p=parseInt($(this).attr("page"));p!=globalCurrentPage&&(globalCurrentPage=p,ajaxGetFilteredData())})),$(document).on("change",".customPaginationDrop",(function(e){var p=parseInt($("option:selected",this).attr("page"));p!=globalCurrentPage&&(globalCurrentPage=p,ajaxGetFilteredData())}))}function renderPagination(response,dataLimit){var i=1,html="",tableInfo="",dropdown="";if(response.error)tableInfo+="0/0",html+="",dropdown+="";else{var elemDataJson=response.data;if(elemDataJson.totalitem<=dataLimit?tableInfo+=elemDataJson.totalitem+" elementi su "+elemDataJson.totalitem:tableInfo+=dataLimit+" elementi su "+elemDataJson.totalitem,elemDataJson.totalitem>dataLimit){var maxPage=Math.floor(elemDataJson.totalitem/dataLimit)+1;for(elemDataJson.totalitem%dataLimit==0&&maxPage--,globalCurrentPage>1&&(html+='<li page="'+(globalCurrentPage-1)+'"><span aria-hidden="true"> &laquo; </span></li>');i<=maxPage;i++)dropdown+=i==globalCurrentPage?'<option page="'+i+'" selected><span aria-hidden="true">'+i+"</span></option>":'<option  page="'+i+'"><span aria-hidden="true">'+i+"</span></option>";html+='<select class="customPaginationDrop noSelectize">'+dropdown+"</select>",html+=globalCurrentPage<maxPage?'<li page="'+(globalCurrentPage+1)+'"><span aria-hidden="true"> &raquo; </span></li>':'<li style="visibility:hidden"><span aria-hidden="true">  &raquo; </span></li>'}}$(".limitElem").text(tableInfo),$(".customPagination").html(html)}function calcParamForOrderby(obj){$("th .glyphicon").removeClass("glyphicon-sort-by-"+currentOrderByType.toLowerCase()),(currentOrderByField=obj.attr("fieldname"))!=globalOrderField?(countOrder=0,currentOrderByType="DESC"):(countOrder++,currentOrderByType=countOrder%2?"ASC":"DESC"),obj.find(".sortingOrder").addClass("glyphicon-sort-by-"+currentOrderByType.toLowerCase()),globalOrderField=currentOrderByField}function renderTable(response){if(null!=response.data){var elemDataJson=response.data.items,form_data=null;0==elemDataJson.length?$(".tableToPaste .noData").closest("td").removeClass("d-none"):($(".tableToPaste .noData").closest("td").addClass("d-none"),$.each(elemDataJson,(function(){var elem=$(".tableToCopy").clone();$(elem).removeClass("tableToCopy d-none"),$(".id",elem).text(this.id),$(".level",elem).text(this.level),$(".datetime",elem).text(this.datetime),$(".ip",elem).text(this.ip),$(".useragent",elem).text(this.useragent),$(".referrer",elem).text(this.referrer),$(".query",elem).text(this.query),$(".message",elem).text(this.message),$(elem).appendTo(".tableToPaste"),$(elem).addClass("removeDuplicate")})))}else $(".tableToPaste .noData").closest("td").removeClass("d-none");ajaxCall=!1}function renderFilterField(){var target=$(".tableHeader th").not(".notFilter"),fieldname=null,fieldnamefriendly="Field",filterType=null;$(document).ready((function(){var toClone;$("#field").append('<option value="" selected>Field</option>'),$.each(target,(function(){fieldname=$(this).attr("fieldname"),fieldnamefriendly=$(this).attr("title"),filterType=$(this).attr("filterType"),""==fieldname?$("#field").append('<option filterType="'+filterType+'" class="'+fieldname+'" value="'+fieldname+'" hidden>'+fieldnamefriendly+"</option>"):$("#field").append('<option filterType="'+filterType+'" class="'+fieldname+'" value="'+fieldname+'">'+fieldnamefriendly+"</option>")})),addFilter($(".filterToClone").clone()),initializeFilterFromSession($("#log_filter"))}))}function initializeFilterFromSession(element){var sessionFilters=JSON.parse($(element).val());if(""==sessionFilters)return ajaxGetFilteredData(),!1;for(var filterName=null,filterCondition=null,filterValue=null,i=1;i<sessionFilters.fields.length;i++)$(".addFilter").trigger("click");var fields=$("#container_filter select[name='field']"),conditions=$("#container_filter select[name='condition']"),values=$(".input").children();$("#sortingTable option[value='"+sessionFilters.perPage+"']").attr("selected","selected"),globalCurrentPage=parseInt(sessionFilters.currentPage),globalOrderField=sessionFilters.orderBy,$(".tableHeader th[fieldname='"+sessionFilters.orderBy+"']").length&&(countOrder=0,"DESC"==sessionFilters.orderType&&(countOrder=1),calcParamForOrderby($(".tableHeader th[fieldname='"+sessionFilters.orderBy+"']")));for(var i=0;i<sessionFilters.fields.length;i++)filterName=sessionFilters.fields[i][0],filterCondition=sessionFilters.fields[i][1],filterValue=sessionFilters.fields[i][2],filterName==defaultParam.field&&filterCondition==defaultParam.rule&&filterValue==defaultParam.input||($(fields[i]).val(filterName).trigger("change"),$(conditions[i]).val(filterCondition).trigger("change"),$(values[i]).val(filterValue));ajaxGetFilteredData()}return{init:init}}}));